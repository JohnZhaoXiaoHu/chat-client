{"version":3,"sources":["webpack:///./src/views/one2one.vue?4236","webpack:///./src/views/one2one.vue?f59a","webpack:///./src/views/one2one.vue","webpack:///./src/views/one2one.vue?5e4c","webpack:///./src/views/one2one.vue?0255","webpack:///./src/views/one2one.vue?0aa5"],"names":["render","_vm","this","_h","$createElement","_c","_self","class","$style","rtcInner","ref","on","sendCall","_v","disconnect","staticRenderFns","mediaStream","peerOut","RTCPeerConnection","peerIn","createOffer","offer","setLocalDescription","setRemoteDescription","addStream","createAnswer","answer","outVideo","navigator","mediaDevices","enumerateDevices","devices","find","item","kind","alert","getUserMedia","video","audio","srcObject","onicecandidate","e","candidate","addIceCandidate","play","sendOffer","name","console","log","tracks","getTracks","close","track","stop","onaddstream","inVideo","stream","outReceive","injectStyles","context","locals","component","VBtn","module","exports"],"mappings":"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","file":"js/one2one.695566d0.js","sourcesContent":["export { default } from  \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--11-oneOf-0-0!../../node_modules/css-loader/dist/cjs.js??ref--11-oneOf-0-1!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--11-oneOf-0-2!../../node_modules/stylus-loader/index.js??ref--11-oneOf-0-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./one2one.vue?vue&type=style&index=0&lang=stylus&rel=stylesheet%2Fstylus&module=true&\"; export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--11-oneOf-0-0!../../node_modules/css-loader/dist/cjs.js??ref--11-oneOf-0-1!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--11-oneOf-0-2!../../node_modules/stylus-loader/index.js??ref--11-oneOf-0-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./one2one.vue?vue&type=style&index=0&lang=stylus&rel=stylesheet%2Fstylus&module=true&\"","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{class:_vm.$style.rtcInner},[_c('div',[_c('video',{ref:\"outVideo\"})]),_c('div',[_c('video',{ref:\"outReceive\"})]),_c('div',[_c('video',{ref:\"inVideo\"})]),_c('v-btn',{on:{\"click\":_vm.sendCall}},[_vm._v(\"呼叫\")]),_c('v-btn',{on:{\"click\":_vm.disconnect}},[_vm._v(\"断开\")])],1)}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","\n\n\n\n\n\n\n\n\n\n\n\n\r\n// https://juejin.im/post/6866252061336567822#heading-1\r\nimport { Component, Ref, Vue } from 'vue-property-decorator'\r\n\r\n/*\r\nhttps://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling\r\n基本流程：\r\n  发送端和接收端创建本地代理（RTCPeerConnection），并监听对等端媒体流\r\n  发送端获取媒体流\r\n  发送端代理添加视频流\r\n  发送端监听本地候选信息，如果已经准备好了，就发送到对等端\r\n  发送端准备发送通话邀请\r\n  发送端穿件会话邀请\r\n  发送端创建会话邀请信息描述\r\n  发送端设置本地会话信息描述为会话邀请信息描述\r\n  通过信令服务器将会话邀请信息描述发送给接收端\r\n  接收端接收会话信息，设置为远端会话描述\r\n  接收端创建应答会话信息描述，并设置为本地会话信息描述\r\n  通过信令服务器将应答会话信息描述发送给发送端\r\n  发送端设置应答会话信息为远端会话描述\r\n  两端交换候选信息，直至有一个候选信息一致\r\n  建立连接\r\n  持续交换候选信息（为了选择更好的候选信息）\r\n*/\r\n@Component\r\nexport default class WebRTC extends Vue {\r\n  // 本地视频流\r\n  mediaStream: MediaStream | null = null\r\n  // 呼叫端代理\r\n  peerOut: RTCPeerConnection = new RTCPeerConnection()\r\n  // 对等端代理\r\n  peerIn: RTCPeerConnection = new RTCPeerConnection()\r\n\r\n  // 呼叫端视频\r\n  @Ref('outReceive') outReceive!: HTMLVideoElement\r\n  // 呼叫端拿到的对等端视频\r\n  @Ref('outVideo') outVideo!: HTMLVideoElement\r\n  // 对等端拿到的呼叫端的视频\r\n  @Ref('inVideo') inVideo!: HTMLVideoElement\r\n\r\n  async sendOffer ():Promise<void> {\r\n    const { peerOut, peerIn } = this\r\n    // 创建邀请，真实情况下需通过信令服务器发送给对等端\r\n    const offer = await peerOut.createOffer()\r\n    // 呼叫端设置本地描述\r\n    await peerOut.setLocalDescription(offer)\r\n    // 呼叫端设置远端描述，真实情况下应该是由信令服务器发送而来\r\n    await peerIn.setRemoteDescription(offer)\r\n    // 对等端添加视频流，这样才能够被呼叫端拿到\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    peerIn.addStream(this.mediaStream)\r\n    // 对等端创建应答\r\n    const answer = await peerIn.createAnswer()\r\n    // 对等端设置本地描述为应答\r\n    await peerIn.setLocalDescription(answer)\r\n    // 呼叫端设置应答，真实情况应该由信令服务器发送而来\r\n    await peerOut.setRemoteDescription(answer)\r\n  }\r\n\r\n  /**\r\n   * 发送呼叫\r\n   */\r\n  async sendCall ():Promise<void> {\r\n    try {\r\n      const { outVideo, peerOut, peerIn } = this\r\n      const { mediaDevices } = navigator\r\n      // 如果不支持音视频输入则弹框警告\r\n      const devices:Array<MediaDeviceInfo> = await mediaDevices.enumerateDevices()\r\n      if (!devices.find((item:MediaDeviceInfo) => item.kind === 'audioinput')) {\r\n        alert('设备不支持音频')\r\n      }\r\n      if (!devices.find((item:MediaDeviceInfo) => item.kind === 'videoinput')) {\r\n        alert('设备不支持视频')\r\n      }\r\n      // 获取媒体流，并播放到Video\r\n      this.mediaStream = await mediaDevices.getUserMedia({\r\n        video: true,\r\n        audio: true\r\n      })\r\n      outVideo.srcObject = this.mediaStream\r\n      // 呼叫端添加视频流\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      peerOut.addStream(this.mediaStream)\r\n      peerOut.onicecandidate = (e:RTCPeerConnectionIceEvent) => {\r\n        // 本地代理通过信令服务器传递信息给其他对等端是触发，用于将ICE候选信息发送给对等端\r\n        if (e.candidate) {\r\n          peerIn.addIceCandidate(e.candidate)\r\n        }\r\n      }\r\n      await outVideo.play()\r\n      await this.sendOffer()\r\n    } catch (e) {\r\n      if (e.name === 'TypeError') {\r\n        alert('当前环境不支持视频通话')\r\n      } else if (e.name === 'NotAllowedError') {\r\n        alert('请允许使用摄像头')\r\n      } else if (e.name === 'AbortError') {\r\n        console.log('中止')\r\n      } else if (e.name === 'NotFoundError') {\r\n        console.log('找不到')\r\n      } else if (e.name === 'OverConstrainedError') {\r\n        console.log('设备无法满足要求')\r\n      } else if (e.name === 'SecurityError') {\r\n        console.log('由于安全原因，被禁止')\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   *关闭本地和远程连接，关闭本地媒体轨道\r\n   */\r\n  disconnect ():void {\r\n    const tracks = this.mediaStream?.getTracks() ?? []\r\n    this.peerOut.close()\r\n    this.peerIn.close()\r\n    for (const track of tracks) {\r\n      track.stop()\r\n    }\r\n  }\r\n\r\n  mounted ():void {\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    this.peerIn.onaddstream = (e) => {\r\n      // 对等端接收呼叫端的视频流，此事件只有在呼叫端和对等端建立连接之后才会触发\r\n      this.inVideo.srcObject = e.stream\r\n      this.inVideo.play()\r\n    }\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    this.peerOut.onaddstream = (e) => {\r\n      // 呼叫端接收对等端的视频流，此事件只有在呼叫端和对等端建立连接之后才会触发\r\n      this.outReceive.srcObject = e.stream\r\n      this.outReceive.play()\r\n    }\r\n  }\r\n}\r\n","import mod from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--14-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??ref--14-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./one2one.vue?vue&type=script&lang=ts&\"; export default mod; export * from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--14-0!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js!../../node_modules/ts-loader/index.js??ref--14-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./one2one.vue?vue&type=script&lang=ts&\"","import { render, staticRenderFns } from \"./one2one.vue?vue&type=template&id=4a3446c0&lang=pug&\"\nimport script from \"./one2one.vue?vue&type=script&lang=ts&\"\nexport * from \"./one2one.vue?vue&type=script&lang=ts&\"\nimport style0 from \"./one2one.vue?vue&type=style&index=0&lang=stylus&rel=stylesheet%2Fstylus&module=true&\"\n\n\n\n\nfunction injectStyles (context) {\n  \n  this[\"$style\"] = (style0.locals || style0)\n\n}\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  injectStyles,\n  null,\n  null\n  \n)\n\nexport default component.exports\n\n/* vuetify-loader */\nimport installComponents from \"!../../node_modules/vuetify-loader/lib/runtime/installComponents.js\"\nimport { VBtn } from 'vuetify/lib/components/VBtn';\ninstallComponents(component, {VBtn})\n","// extracted by mini-css-extract-plugin\nmodule.exports = {\"rtcInner\":\"one2one_rtcInner_3ewLw\"};"],"sourceRoot":""}